import 'package:flutter/material.dart';
import 'package:nearby_connections/nearby_connections.dart';
import 'package:permission_handler/permission_handler.dart';

void main() => runApp(const MaterialApp(home: MeshScreen()));

class MeshScreen extends StatefulWidget {
  const MeshScreen({super.key});
  @override
  State<MeshScreen> createState() => _MeshScreenState();
}

class _MeshScreenState extends State<MeshScreen> {
  final Strategy strategy = Strategy.P2P_CLUSTER;
  String status = "Ready";
  List<String> logs = [];

  void _addLog(String m) => setState(() => logs.insert(0, m));

  void _initMesh() async {
    await [
      Permission.bluetooth,
      Permission.bluetoothAdvertise,
      Permission.bluetoothConnect,
      Permission.bluetoothScan,
      Permission.location
    ].request();

    bool a = await Nearby().startAdvertising(
      "Node_${DateTime.now().second}",
      strategy,
      onConnectionInitiated: (id, info) async {
        await Nearby().acceptConnection(
          id, 
          onPayLoadReceived: (id, payload) => _addLog("Got data"),
          onPayloadTransferUpdate: (id, update) {},
        );
      },
      onConnectionResult: (id, s) => _addLog("Adv: $s"),
      onDisconnected: (id) => _addLog("Disc: $id"),
    );

    bool d = await Nearby().startDiscovery(
      "Node_${DateTime.now().second}",
      strategy,
      onEndpointFound: (id, n, s) {
        Nearby().requestConnection(
          "Node",
          id,
          onConnectionInitiated: (id, info) async {
            await Nearby().acceptConnection(
              id, 
              onPayLoadReceived: (id, payload) => _addLog("Got data"),
              onPayloadTransferUpdate: (id, update) {},
            );
          },
          onConnectionResult: (id, s) => _addLog("Conn: $s"),
          onDisconnected: (id) => _addLog("Disc: $id"),
        );
      },
      onEndpointLost: (id) => _addLog("Lost: $id"),
    );

    setState(() => status = (a && d) ? "Active" : "Error");
  }

  @override
  void initState() {
    super.initState();
    _initMesh();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Mesh Test")),
      body: Column(
        children: [
          Text(status, style: const TextStyle(fontSize: 24)),
          Expanded(child: ListView(children: logs.map((l) => ListTile(title: Text(l))).toList())),
        ],
      ),
    );
  }
}
