import 'package:flutter/material.dart';
import 'package:nearby_connections/nearby_connections.dart';
import 'package:permission_handler/permission_handler.dart';

void main() => runApp(const MaterialApp(home: MeshScreen()));

class MeshScreen extends StatefulWidget {
  const MeshScreen({super.key});
  @override
  State<MeshScreen> createState() => _MeshScreenState();
}

class _MeshScreenState extends State<MeshScreen> {
  final Strategy strategy = Strategy.P2P_CLUSTER;
  String status = "Ready";
  List<String> logs = [];

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) => _initMesh());
  }

  void _addLog(String m) => setState(() => logs.insert(0, m));

  Future<void> _initMesh() async {
    setState(() => status = "Requesting Permissions...");
    
    Map<Permission, PermissionStatus> statuses = await [
      Permission.bluetooth,
      Permission.bluetoothAdvertise,
      Permission.bluetoothConnect,
      Permission.bluetoothScan,
      Permission.location,
    ].request();

    if (statuses.values.any((element) => element.isDenied)) {
      setState(() => status = "Permission Denied");
      return;
    }

    setState(() => status = "Starting Mesh...");
    dynamic nearby = Nearby();

    try {
      bool a = await nearby.startAdvertising(
        "Node_${DateTime.now().millisecond}",
        strategy,
        onConnectionInitiated: (id, info) async {
          await nearby.acceptConnection(
            id, 
            onPayloadReceived: (id, payload) => _addLog("Data"),
            onPayloadTransferUpdate: (id, update) {},
          );
        },
        onConnectionResult: (id, s) => _addLog("Adv: $s"),
        onDisconnected: (id) => _addLog("Disc: $id"),
      );

      bool d = await nearby.startDiscovery(
        "Node_${DateTime.now().millisecond}",
        strategy,
        onEndpointFound: (id, n, s) {
          nearby.requestConnection(
            "Node",
            id,
            onConnectionInitiated: (id, info) async {
              await nearby.acceptConnection(
                id, 
                onPayloadReceived: (id, payload) => _addLog("Data"),
                onPayloadTransferUpdate: (id, update) {},
              );
            },
            onConnectionResult: (id, s) => _addLog("Conn: $s"),
            onDisconnected: (id) => _addLog("Disc: $id"),
          );
        },
        onEndpointLost: (id) => _addLog("Lost: $id"),
      );

      setState(() => status = (a && d) ? "Active" : "Mesh Error");
    } catch (e) {
      setState(() => status = "Fatal Error");
      _addLog(e.toString());
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Mesh Test")),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.all(20),
            child: Text(status, style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
          ),
          ElevatedButton(onPressed: _initMesh, child: const Text("Retry Init")),
          Expanded(child: ListView(children: logs.map((l) => ListTile(title: Text(l))).toList())),
        ],
      ),
    );
  }
}
