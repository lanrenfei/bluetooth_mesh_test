import 'package:flutter/material.dart';
import 'package:nearby_connections/nearby_connections.dart';
import 'package:permission_handler/permission_handler.dart';

void main() => runApp(const MaterialApp(home: MeshScreen()));

class MeshScreen extends StatefulWidget {
  const MeshScreen({super.key});
  @override
  State<MeshScreen> createState() => _MeshScreenState();
}

class _MeshScreenState extends State<MeshScreen> {
  final Strategy strategy = Strategy.P2P_CLUSTER;
  String status = "正在初始化...";
  List<String> logs = [];

  @override
  void initState() {
    super.initState();
    _initMesh();
  }

  void _initMesh() async {
    await [
      Permission.bluetooth,
      Permission.bluetoothAdvertise,
      Permission.bluetoothConnect,
      Permission.bluetoothScan,
      Permission.location
    ].request();

    void onPayloadRec(String id, Payload payload) {
      _addLog("Data from $id");
    }

    bool a = await Nearby().startAdvertising(
      "Node_${DateTime.now().second}",
      strategy,
      onConnectionInitiated: (id, info) => Nearby().acceptConnection(id, onPayloadReceived: onPayloadRec),
      onConnectionResult: (id, s) => _addLog("Adv Result: $s"),
      onDisconnected: (id) => _addLog("Adv Disc: $id"),
    );

    bool d = await Nearby().startDiscovery(
      "Node_${DateTime.now().second}",
      strategy,
      onEndpointFound: (id, n, s) {
        Nearby().requestConnection(
          "Node", 
          id, 
          onConnectionInitiated: (id, info) => Nearby().acceptConnection(id, onPayloadReceived: onPayloadRec),
          onConnectionResult: (id, s) => _addLog("Disc Result: $s"),
          onDisconnected: (id) => _addLog("Disc Disc: $id"),
        );
      },
      onEndpointLost: (id) => _addLog("Lost: $id"),
    );

    setState(() => status = (a && d) ? "Mesh Active" : "Mesh Failed");
  }

  void _addLog(String m) => setState(() => logs.insert(0, m));

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Mesh Test")),
      body: Column(
        children: [
          Container(
            padding: const EdgeInsets.all(16),
            color: Colors.green.shade100,
            child: Text(status, style: const TextStyle(fontWeight: FontWeight.bold)),
          ),
          Expanded(child: ListView(children: logs.map((l) => ListTile(title: Text(l))).toList())),
        ],
      ),
    );
  }
}
