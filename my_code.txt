import 'package:flutter/material.dart';
import 'package:nearby_connections/nearby_connections.dart';
import 'package:permission_handler/permission_handler.dart';

void main() => runApp(const MaterialApp(home: MeshScreen()));

class MeshScreen extends StatefulWidget {
  const MeshScreen({super.key});
  @override
  State<MeshScreen> createState() => _MeshScreenState();
}

class _MeshScreenState extends State<MeshScreen> {
  final Strategy strategy = Strategy.P2P_CLUSTER;
  String status = "正在初始化蓝牙...";
  List<String> logs = [];

  @override
  void initState() {
    super.initState();
    _initMesh();
  }

  void _initMesh() async {
    await [Permission.bluetooth, Permission.bluetoothAdvertise, Permission.bluetoothConnect, Permission.bluetoothScan, Permission.location].request();
    bool a = await Nearby().startAdvertising("Node_${DateTime.now().second}", strategy, 
      onConnectionInitiated: (id, info) => Nearby().acceptConnection(id, onPayLoadReceived: (id, p) {}),
      onConnectionResult: (id, s) => _addLog("连接: $s"),
      onDisconnected: (id) => _addLog("断开: $id"));
    bool d = await Nearby().startDiscovery("Node_${DateTime.now().second}", strategy,
      onEndpointFound: (id, n, s) => Nearby().requestConnection("Node", id, onConnectionInitiated: (id, info) => Nearby().acceptConnection(id, onPayLoadReceived: (id, p) {})),
      onEndpointLost: (id) => _addLog("邻居离开"));
    setState(() => status = (a && d) ? "Mesh组网已激活" : "启动失败");
  }

  void _addLog(String m) => setState(() => logs.insert(0, m));

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Mesh Test")),
      body: Column(children: [
        Padding(padding: const EdgeInsets.all(8.0), child: Text(status, style: const TextStyle(fontWeight: FontWeight.bold))),
        Expanded(child: ListView(children: logs.map((e) => ListTile(title: Text(e))).toList())),
      ]),
    );
  }
}
